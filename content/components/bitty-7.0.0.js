const t=[7,0,0],e=`bitty-${t[0]}-${t[1]}`;class n extends Error{constructor(t){super(),Error.captureStackTrace&&Error.captureStackTrace(this,n),this.name="BittyError";for(let[e,n]of Object.entries(t))this[e]=n}}class s extends Event{constructor(t,e){super("bittyforward",{bubbles:!0}),this.forwardedEvent=t,this.forwardedSignal=e}}class a extends Event{constructor(t,e){super("bittylocaltrigger",{bubbles:!0}),this.signal=t,this.localId=e}}class r extends Event{constructor(t){super("bittytrigger",{bubbles:!0}),this.signal=t}}function i(t,e){if(void 0!==t.dataset)return void 0!==t.dataset[e]?t.dataset[e]:t.parentNode?i(t.parentNode,e):void 0}class o extends HTMLElement{constructor(){super(),this.config={listeners:["click","input"],license:"CC0",version:t}}async connectedCallback(){this.dataset.bittyid=self.crypto.randomUUID(),this.bittyId=this.dataset.bittyid,await this.makeConnection(),this.conn&&(this.conn.api=this,this.setIds(this),this.handleEventBridge=this.handleEvent.bind(this),this.addEventListeners(),await this.runBittyInit(),await this.runDataInits(),await this.runBittyReady())}addEventListeners(){const t=["bittyforward","bittylocaltrigger","bittytrigger"];this.dataset.listeners?this.trimInput(this.dataset.listeners).forEach(e=>{t.push(e)}):(t.push("click"),t.push("input")),t.forEach(t=>{window.addEventListener(t,t=>{this.handleEventBridge.call(this,t)})})}connectedMoveCallback(){}doSubs(t,e){return e.forEach(e=>{const n=typeof e[1],s=Object.prototype.toString.call(e[1]);if("object"===n&&"[object Array]"===s){const n=e[1].map(t=>{const e=typeof t,n=Object.prototype.toString.call(t);return"object"===e&&"[object DocumentFragment]"===n?[...t.childNodes].map(t=>"[object Text]"===Object.prototype.toString.call(t)?t.wholeText:t.outerHTML).join(""):"object"===e?t.outerHTML:t}).join("");t=t.replaceAll(e[0],n)}else if("object"===n&&"[object DocumentFragment]"===s){const n=[];[...e[1].childNodes].forEach(t=>{"[object Text]"===Object.prototype.toString.call(t)?n.push(t.wholeText):n.push(t.outerHTML)}),t=t.replaceAll(e[0],n.join(""))}else t="object"==typeof e[1]?t.replaceAll(e[0],e[1].outerHTML):t.replaceAll(e[0],e[1])}),t}expandElement(t,e){null!==t&&(e.isTarget=t.target.dataset.bittyid===e.dataset.bittyid,e.isSender=t.sender.dataset.bittyid===e.dataset.bittyid),e.bittyParent=this.getBittyParent(e),e.prop=t=>i.call(null,e,t),e.propToInt=t=>parseInt(i.call(null,e,t)),e.propToFloat=t=>parseFloat(i.call(null,e,t)),e.value&&(e.valueToInt=parseInt(e.value,10),e.valueToFloat=parseFloat(e.value)),e.propMatchesTarget=n=>{const s=i.call(null,t.target,n),a=i.call(null,e,n);return void 0!==s&&void 0!==a&&s===a},e.propMatchesSender=n=>{const s=i.call(null,t.sender,n),a=i.call(null,e,n);return void 0!==s&&void 0!==a&&s===a}}expandEvent(t){t.sender=this.findSender(t.target),t.sender&&t.sender.dataset&&t.sender.dataset.bittyid&&(t.sender.bittyId=t.sender.dataset.bittyid),t.sender.dataset&&t.sender.dataset.send&&(t.sendPayload=t.sender.dataset.send),t.sender&&t.sender.value&&(t.sender.valueToInt=parseInt(t.sender.value,10),t.sender.valueToFloat=parseFloat(t.sender.value)),t.sender&&(t.sender.prop=e=>i.call(null,t.sender,e),t.sender.propToInt=e=>parseInt(i.call(null,t.sender,e),10),t.sender.propToFloat=e=>parseFloat(i.call(null,t.sender,e))),void 0!==t.target.value&&(t.value=t.target.value,t.valueToInt=parseInt(t.target.value,10),t.valueToFloat=parseFloat(event.target.value)),t.bittyId=t.target.dataset.bittyid,t.prop=e=>i.call(null,t.target,e),t.propToInt=e=>parseInt(i.call(null,t.target,e)),t.propToFloat=e=>parseFloat(i.call(null,t.target,e))}findSender(t){return t.dataset&&t.dataset.send||t.dataset&&t.dataset.use?t:t.parentNode?this.findSender(t.parentNode):this}forward(t,e){const n=new s(t,e);this.dispatchEvent(n)}getBittyParent(t){return t.localName.toLowerCase()===e?t:t.parentNode?this.getBittyParent(t.parentNode):this}async getElement(t,e=[],n={}){const s=await this.getHTML(t,e,n,"getElement");if(s.value){return{value:s.value.firstChild}}return s}async getHTML(t,e=[],n={}){const s=await this.getTXT(t,e,n,"getHTML");return s.error?s:{value:this.makeHTML(s.value,e)}}async getJSON(t,e=[],s={}){const a=await this.getTXT(t,e,s,"getJSON");if(a.error)return a;try{const t=JSON.parse(a.value);return{value:t}}catch(t){return{error:new n({type:"parsing"})}}}async getSVG(t,e=[],n={}){const s=await this.getTXT(t,e,n,"getSVG");if(s.error)return s;{const t=document.createElement("template");t.innerHTML=s.value;return{value:t.content.cloneNode(!0).querySelector("svg")}}}async getTXT(t,e=[],s={},a="getTXT"){let r=await fetch(t,s);try{if(r.ok){return{value:this.doSubs(await r.text(),e)}}throw new n({type:"fetching",message:`${a}() returned ${r.status} [${r.statusText}] in:\n${a}(${r.url}, ${JSON.stringify(e)}, ${JSON.stringify(s)})`,statusText:r.statusText,status:r.status,url:r.url,incomingMethod:a,subs:e,options:s})}catch(t){return console.error(`BittyError: ${t.message}`),{error:t}}}async handleEvent(t){if("bittyforward"===t.type){const e=t.forwardedEvent;e.sendPayload=t.forwardedSignal,await this.processEvent(e)}else if(this.expandEvent(t),"bittylocaltrigger"===t.type)t.sendPayload=t.signal,await this.processEvent(t);else if("bittytrigger"===t.type)t.sendPayload=t.signal,await this.processEvent(t);else{if(t.sender.dataset.use){const e=this.trimInput(t.sender.dataset.use);for(let n of e){let e=!1;const s=n.split(":");2===s.length&&"await"===s[0]&&(e=!0,n=s[1]),this.conn[n]&&(this.expandElement(t,t.sender),e?await this.conn[n](t,t.sender):this.conn[n](t,t.sender))}}t.sender.dataset.send&&(t.sendPayload=t.sender.dataset.send,await this.processEvent(t))}}async loadCSS(t,e=[],n={}){const s=await this.getTXT(t,e,n,"loadCSS");if(s.error)return s;{const t=new CSSStyleSheet;return t.replaceSync(s.value),document.adoptedStyleSheets.push(t),{value:s.value}}}localTrigger(t){const e=new a(t,this.bittyId);this.dispatchEvent(e)}async makeConnection(){try{if(this.dataset.connect){let t=this.trimInput(this.dataset.connect);if(void 0!==window[t[0]])this.conn=new window[t[0]];else{if("/"===t[0].substring(0,1)){const e=new URL(window.location.href);t[0]=new URL(t[0],e.origin).toString()}if("http"===t[0].substring(0,4)){const n=await import(t[0]);if(void 0===t[1])try{this.conn=new n.default}catch(t){console.error(`${e} error [${t}] - data-connect="${this.dataset.connect}" failed - Check the file "${this.dataset.connect}" to make sure it has an "export default class {}"`)}else try{this.conn=new n[t[1]]}catch(n){console.error(`${e} error [${n}] - data-connect="${this.dataset.connect}" failed - Check the file "${t[0]}" to make sure it has an "export class ${t[1]} {}"`)}}else console.error(`${e} error: Tried to use 'data-connect="${this.dataset.connect}" which did not match a class on the page which means an attempt to use it as a URL was made. It failed becasue the URL version of 'data-connect' must start with 'http' or '/'. Other URLs are not currently supported`)}}else window.BittyClass?this.conn=new window.BittyClass:console.error(`${e} error: Could not find "window.BittyClass" on the page to connect to (which is needed because there is no "data-connect" attribute).`)}catch(t){console.error(`${e} error: [${t}] - ${this.dataset.connect}`)}}makeElement(t,e=[]){return this.makeHTML(t,e).firstChild}makeHTML(t,e=[]){const n=document.createElement("template");n.innerHTML=this.makeTXT(t,e).trim();const s=n.content.cloneNode(!0);return this.setIds(s),s}makeSVG(t,e=[]){const n=document.createElement("template");n.innerHTML=this.makeTXT(t,e).trim();return n.content.cloneNode(!0).querySelector("svg")}makeTXT(t,e=[]){return this.doSubs(t,e)}async processEvent(t){if(t.localId&&t.localId!==this.bittyId)return null;if(t.sendPayload){const e=this.trimInput(t.sendPayload);for(let n of e){let e=!1;const s=n.split(":");if(2===s.length&&"await"===s[0]&&(e=!0,n=s[1]),this.conn[n]){let s=!1;const a=this.querySelectorAll("[data-receive]");for(let r of a){const a=this.trimInput(r.dataset.receive);for(let i of a){const a=i.split(":");2===a.length&&"await"===a[0]&&(i=a[1]),i===n&&(s=!0,this.expandElement(t,r),e?await this.conn[n](t,r):this.conn[n](t,r))}}!1===s&&(e?await this.conn[n](t,null):this.conn[n](t,null))}}}}async runBittyInit(){"function"==typeof this.conn.bittyInit&&("AsyncFunction"===this.conn.bittyInit[Symbol.toStringTag]?await this.conn.bittyInit():this.conn.bittyInit())}async runBittyReady(){"function"==typeof this.conn.bittyReady&&("AsyncFunction"===this.conn.bittyReady[Symbol.toStringTag]?await this.conn.bittyReady():this.conn.bittyReady())}async runDataInits(){if(this.dataset.init){const t=this.trimInput(this.dataset.init);for(let e of t)"function"==typeof this.conn[e]&&("AsyncFunction"===this.conn[e][Symbol.toStringTag]?await this.conn[e](null,this):this.conn[e](null,this))}for(let t of this.querySelectorAll("[data-init]"))if(t.dataset.init){this.expandElement(null,t);const e=this.trimInput(t.dataset.init);for(let n of e)"function"==typeof this.conn[n]&&("AsyncFunction"===this.conn[n][Symbol.toStringTag]?await this.conn[n](null,t):this.conn[n](null,t))}}setProp(t,e){document.documentElement.style.setProperty(t,e)}setIds(t){t.querySelectorAll("*").forEach(t=>{t.dataset.bittyid||(t.dataset.bittyid=self.crypto.randomUUID()),t.bittyId||(t.bittyId=t.dataset.bittyid)})}trigger(t){const e=new r(t);this.dispatchEvent(e)}trimInput(t){return t.trim().split(/\s+/m).map(t=>t.trim())}async getQuickElement(t,e=[],n={}){const s=await this.getElement(t,e,n);return s.value?s.value:this.makeElement('<span class="bitty-error">Error (check console)</span>')}async getQuickHTML(t,e=[],n={}){const s=await this.getElement(t,e,n);return s.value?s.value:this.makeHTML('<span class="bitty-error">Error (check console)</span>')}async getQuickJSON(t,e=[],n={}){const s=await this.getJSON(t,e,n);return s.value?s.value:s.error}async getQuickSVG(t,e=[],n={}){const s=await this.getSVG(t,e,n);if(s.value)return s.value;{const t=document.createElement("template");t.innerHTML='<svg version="1.1" width="120" height="32" xmlns="http://www.w3.org/2000/svg"><text x="60" y="16" font-size="12" text-anchor="middle" fill="red">error (check console)</text></svg>';return t.content.cloneNode(!0).querySelector("svg")}}async getQuickTXT(t,e=[],n={}){const s=await this.getTXT(t,e,n);return s.value?s.value:s.error}}customElements.define(e,o);